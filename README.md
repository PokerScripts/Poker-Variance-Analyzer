# Симулятор дисперсии и риска в покере

**Poker-Variance-Analyzer** `variance.py` - это однофайловый CLI-инструмент для оценки дисперсии покерных результатов: доверительные интервалы, вероятность даунстрика, Risk of Ruin, а также Монте-Карло симуляции траекторий банкролла.

---

## Возможности

* Анализ **cash** и **MTT/SnG** профилей с автоопределением режима по столбцам.
* Базовые метрики: `mean`, `median`, `std`, `CV`, доверительный интервал среднего.
* Оценка **winrate** (bb/100) и σ для cash или **ROI** и σ (в бай-инах) для MTT.
* Вероятность даунстрика (просадки) на заданном горизонте.
* Приближённый **Risk of Ruin** и оценка RoR через Монте-Карло.
* Монте-Карло симуляции с нормальным или t-распределением (толстые хвосты).
* Визуализация примерных траекторий и финального распределения (PNG).
* Экспорт результатов в **CSV** и сводных метрик в **JSON**.

---

## Быстрый старт

```bash
# Клонирование
git clone https://github.com/PokerScripts/Poker-Variance-Analyzer.git
cd Poker-Variance-Analyzer

# Помощь
python variance.py --help
```

Минимальный прогон без файла (MTT, ввод параметров напрямую):

```bash
VARIANCE_BANKROLL="100bi" \
python variance.py --mode mtt --roi_ev 0.10 --sd_buyins 1.3 \
  --samples 500 --nsims 20000 --drawdown 20bi --alpha 0.05
```

---

## Установка

Требуется **Python 3.9+**.

Рекомендуется виртуальная среда:

```bash
python -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install --upgrade pip
```

Зависимости:

* Базово: `numpy`
* Для чтения CSV/JSON и экспорта: `pandas`
* Для графиков (опционально): `matplotlib`

```bash
pip install numpy pandas matplotlib
```

> Скрипт корректно работает и без `matplotlib` (без графиков) и без `pandas` (если не читаете/пишете файлы), но для полного функционала они нужны.

---

## Входные данные

Скрипт принимает:

* **CSV** или **JSON** с вашими результатами, **или**
* прямой ввод параметров распределения через CLI.

### Формат CSV/JSON

Каждая строка — одно наблюдение: турнир, сессия или агрегированный блок рук.

#### Пример CSV для **MTT**:

```csv
date,buyin,prize,entries,format
2025-03-01T20:15:00,11,0,1045,MTT
2025-03-02T19:55:00,11,76.32,980,MTT
```

#### Пример CSV для **Cash** (результат в bb):

```csv
date,hands,result
2025-03-01,750,35
2025-03-02,420,-120
```

#### Пример CSV для **Cash** (результат в валюте):

```csv
date,hands,result,bb
2025-03-01,500,18.50,0.1
2025-03-02,1200,-43.00,0.1
```

### Поля для MTT/SnG

* `buyin` — бай-ин (включая рейк), **> 0**
* `prize` — призовые (0, если нет ITM)
* `entries`, `format` — опционально
* Внутри скрипта нормируется метрика:
  `result_bi = (prize - buyin) / buyin` (в «бай-инах»)

### Поля для Cash

* `result` — итог сессии **в bb** или **в валюте**
* `hands` — количество рук (желательно; повышает точность wr/σ)
* `bb` — размер большого блайнда (нужен, если `result` в валюте)
* Внутри скрипта всё приводится к **bb**.

---

## Использование (CLI)

Общий вид:

```bash
python variance.py \
  --input results.csv \
  --mode mtt|cash \
  --currency USD \
  --bb "1$" \
  --avg_buyin "55$" \
  --horizon 100t|5000h|50s \
  --drawdown 20bi|1000bb|500$ \
  --alpha 0.05 \
  --nsims 20000 \
  --seed 42 \
  --heavy-tailed \
  --plot bankroll.png \
  --out sims.csv \
  --json report.json
```

Ключевые опции:

* `--mode {cash,mtt}` — режим (может автоопределяться по столбцам).
* `--horizon` — горизонт моделирования:

  * cash: `5000h` = 5000 рук (шаги по 100 рук), `50s` = 50 сессий
  * mtt: `100t` = 100 турниров
* `--drawdown` — порог просадки, единицы: `bb`, `bi`, `$`.
* `--nsims` — число Монте-Карло симуляций.
* `--heavy-tailed` — t-распределение (`df=5`) вместо нормального.
* `--plot` — путь к PNG-графику.
* `--out` — CSV с финальными результатами симуляций.
* `--json` — JSON со сводными метриками.

Ввод параметров без файла:

* cash: `--wr_bb100`, `--sd_bb100`, `--hands` или `--sessions`
* mtt: `--roi_ev` (доля, 0.1 = 10%), `--sd_buyins`, `--samples`

**Переменные окружения:**

* `VARIANCE_BANKROLL` — банкролл с единицей (`bb`, `bi`, `$`), например:

  * `VARIANCE_BANKROLL="3000$"` для cash
  * `VARIANCE_BANKROLL="100bi"` для mtt
    Используется в расчётах **Risk of Ruin** и в Монте-Карло (банкротство).

### Примеры

**1) MTT по CSV:**

```bash
python variance.py --input mtt_results.csv --mode mtt \
  --avg_buyin "55$" \
  --horizon 500t --drawdown 20bi --nsims 20000 \
  --plot bankroll.png --json report.json
```

**2) Cash без файла (по статистике):**

```bash
VARIANCE_BANKROLL="3000$" \
python variance.py --mode cash --wr_bb100 3.5 --sd_bb100 95 \
  --horizon 30000h --bb "1$" --nsims 30000 --drawdown 1500$
```

**3) Cash по CSV (результат в bb):**

```bash
python variance.py --input cash_sessions.csv --mode cash \
  --horizon 50s --nsims 15000 --drawdown 1000bb \
  --plot bankroll.png --out sims.csv --json report.json
```

---

## Метрики и модели

* **Cash (bb):**

  * `wr_bb100` — винрейт в bb/100 рук (если есть `hands`)
  * `sd_bb100` — σ в bb/100 (по батчам наблюдений)
  * Сумма за горизонт `H (в шагах по 100 рук)`:

    * `E[S] = H * wr_bb100`
    * `Var[S] = H * sd_bb100²`

* **MTT (в бай-инах):**

  * `ROI` — средний `result_bi`
  * `sd_bi` — σ результата на турнир в бай-инах
  * Сумма за горизонт `T (турниры)`:

    * `E[S] = T * ROI`
    * `Var[S] = T * sd_bi²`

* **Вероятность даунстрика**: нормальное приближение `P(S ≤ T)`.

* **Risk of Ruin (аппроксимация)**:

  * `RoR ≈ exp(-2 * μ * BR / σ²)` при `μ > 0`
  * Единицы: cash → bb, mtt → bi (если банкролл в `$`, требуется `--bb`/`--avg_buyin` для конвертации)

* **Монте-Карло**:

  * Шаг = `100 рук` (cash per100), `сессия` (cash sessions) или `1 турнир` (mtt)
  * Нормальное или t-распределение для приращений
  * Фиксация максимальной просадки и банкротств
  * Результаты: `p10/p50/p90`, `RoR_MC`, `P(final ≥ target)`, `P(drawdown ≥ threshold)`

---

## Артефакты и вывод

* Консольная сводка: основные метрики, риски, квантильные оценки.
* `--plot bankroll.png` — график примерных траекторий (PNG).
* `--out sims.csv` — CSV с финальными результатами симуляций.
* `--json report.json` — JSON со сводными метриками (для CI/ботов/дашбордов).

---

## Краевые случаи и предупреждения

* `< 5` наблюдений во входном файле → отказ с понятным сообщением.
* Смешанные единицы (часть `result` в bb, часть — в валюте без `bb`) → ошибка.
* `hands` отсутствуют для cash → расчёт wr/σ по сессиям (менее точный) с предупреждением.
* `buyin ≤ 0` (MTT) → ошибка.
* Для порогов/банкролла в `$` обязательно указывать `--bb` (cash) или `--avg_buyin` (mtt) для корректной конвертации.

---

## Roadmap / идеи развития

* Учёт рейка отдельно для cash, σ-стабилизация по батчам.
* Бутстрапы и байесовские оценки вместо нормального приближения.
* Поддержка авторазбора Hand History и извлечения результатов.
* Экспорт Markdown/HTML-отчётов.
* Набор unit-тестов и генератор фиктивных CSV.

---

## Лицензия

**MIT** — см. файл `LICENSE`.
